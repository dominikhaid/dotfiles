!function(){function e(e,t,n,r){Object.defineProperty(e,t,{get:n,set:r,enumerable:!0,configurable:!0})}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},n={},r={},s=t.parcelRequire94f3;null==s&&((s=function(e){if(e in n)return n[e].exports;if(e in r){let t=r[e];delete r[e];let s={id:e,exports:{}};return n[e]=s,t.call(s.exports,s,s.exports),s.exports}var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}).register=function(e,t){r[e]=t},t.parcelRequire94f3=s),s.register("2lHoE",(function(t,n){e(t.exports,"asyncToGenerator",(()=>s("35sgH").default)),e(t.exports,"defineProperty",(()=>s("6lnZy").default)),e(t.exports,"extends",(()=>s("59cjE").default)),e(t.exports,"objectSpread",(()=>s("4pbXc").default)),e(t.exports,"objectWithoutProperties",(()=>s("47s9l").default)),e(t.exports,"slicedToArray",(()=>s("6YtmJ").default));s("35sgH"),s("6lnZy"),s("59cjE"),s("4pbXc"),s("47s9l"),s("6YtmJ")})),s.register("35sgH",(function(t,n){function r(e,t,n,r,s,o,i){try{var a=e[o](i),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,s)}function s(e){return function(){var t=this,n=arguments;return new Promise((function(s,o){var i=e.apply(t,n);function a(e){r(i,s,o,a,c,"next",e)}function c(e){r(i,s,o,a,c,"throw",e)}a(void 0)}))}}e(t.exports,"default",(()=>s))})),s.register("6lnZy",(function(t,n){function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}e(t.exports,"default",(()=>r))})),s.register("59cjE",(function(t,n){function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function s(){return r.apply(this,arguments)}e(t.exports,"default",(()=>s))})),s.register("4pbXc",(function(t,n){e(t.exports,"default",(()=>o));var r=s("6lnZy");function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},s=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),s.forEach((function(t){r.default(e,t,n[t])}))}return e}})),s.register("47s9l",(function(t,n){e(t.exports,"default",(()=>o));var r=s("MeKQR");function o(e,t){if(null==e)return{};var n,s,o=r.default(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}})),s.register("MeKQR",(function(t,n){function r(e,t){if(null==e)return{};var n,r,s={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(s[n]=e[n]);return s}e(t.exports,"default",(()=>r))})),s.register("6YtmJ",(function(t,n){e(t.exports,"default",(()=>a));var r=s("2ob6r"),o=s("2nbNe"),i=s("12yoO");function a(e,t){return r.default(e)||o.default(e,t)||i.default()}})),s.register("2ob6r",(function(t,n){function r(e){if(Array.isArray(e))return e}e(t.exports,"default",(()=>r))})),s.register("2nbNe",(function(t,n){function r(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}e(t.exports,"default",(()=>r))})),s.register("12yoO",(function(t,n){function r(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}e(t.exports,"default",(()=>r))})),s.register("64sVI",(function(t,n){e(t.exports,"BackgroundHandler",(()=>i)),e(t.exports,"BackgroundScript",(()=>a));var r=s("4xoKp"),o=s("5wX0M");const i=r.default,a=o.default})),s.register("4xoKp",(function(t,n){e(t.exports,"default",(()=>c));var r=s("6yLte"),o=s("5I6CI"),i=s("3iWja");class a extends r.default{constructor(e={},t={}){super(),this.scriptConnections=new Map,this.exposedData=e,this.errorCallback=t.errorCallback??null,chrome.runtime.onConnect.addListener((e=>this.handleNewConnection(e)))}handleNewConnection(e){if(!this.isInternalConnection(e))return;let[t,n]=this.parsePortName(e),r=e.sender?.tab?.id??null;if(-1==r&&(r=null),this.scriptConnections.get(n))return e.disconnect(),this.handleError(i.BgHandlerErrors.ID_TAKEN,n);let s=new o.Connection(e,this.exposedData,{hasTabId:!1});s.addListener("disconnect",(()=>this.disconnectScript(t,r))),this.scriptConnections.set(n,s),this.fireEvent("connectionreceived",{scriptId:t,tabId:r})}isInternalConnection(e){return e.name.startsWith(o.CONNECTION_PREFIX)||e.name.startsWith(o.CONNECTION_PREFIX_NOTAB)}isTabAgnostic(e){return e.name.startsWith(o.CONNECTION_PREFIX_NOTAB)}parsePortName(e){let t,n,r;return this.isTabAgnostic(e)?t=e.name.substr(o.CONNECTION_PREFIX_NOTAB.length):(t=e.name.substr(o.CONNECTION_PREFIX.length),n=e.sender.tab.id),r=this.generateScriptId(t,n),[t,r]}generateScriptId(e,t){let n=e;return t&&(n+=`-${t}`),n}disconnectScript(e,t){let n=this.generateScriptId(e,t),r=this.scriptConnections.get(n);r&&r.disconnect(),this.scriptConnections.delete(n),this.fireEvent("connectionended",{scriptId:e,tabId:t})}async getScriptConnection(e,t){let n=e;t&&(n+=`-${t}`);let r=this.scriptConnections.get(n);return r?await r.getProxy():(this.handleError(i.BgHandlerErrors.NO_CONNECTION,e,t),null)}hasConnectedScript(e,t){let n=e;return t&&(n+=`-${t}`),this.scriptConnections.has(n)}handleError(e,...t){this.errorCallback?this.errorCallback({errorId:e.id,error:e.getText(...t)}):console.error(e.getText(...t))}}var c=a})),s.register("6yLte",(function(t,n){e(t.exports,"default",(()=>r));var r=class{constructor(){this.listeners=new Map}addListener(e,t){if("function"!=typeof t)throw"The callback must be a function";let n=this.listeners.get(e);n?n.push(t):this.listeners.set(e,[t])}removeListener(e,t){let n=this.listeners.get(e);if(!n)return;let r=n.indexOf(t);r<0||n.splice(r,1)}fireEvent(e,t={}){let n=this.listeners.get(e);if(n)for(let e of n)e(t)}}})),s.register("5I6CI",(function(t,n){e(t.exports,"CONNECTION_PREFIX_NOTAB",(()=>i)),e(t.exports,"CONNECTION_PREFIX",(()=>o)),e(t.exports,"Connection",(()=>x));var r=s("6yLte");const o="bgscript-",i="bgscript.notab-",a="bootstrap",c="bootstrap-answer",d="request-id",l="get",u="set",p="call",h="answer",f="error";class x extends r.default{constructor(e,t={},n={}){super(),this.port=e,this.hasTabId=n.hasTabId??!0,this.proxy=null,this.waitingRequests=new Map,this.nextRequestId=1,this.RESTRICTED_NAMES=["then","$getMyTabId"],this.exposedMethods={},this.exposedProps={},this.remoteMethods=[],this.parseExposedData(t),this.port.onMessage.addListener((e=>this.handleMessage(e))),this.port.onDisconnect.addListener((()=>{this.fireEvent("disconnect")}))}parseExposedData(e){for(let[t,n]of Object.entries(e))this.RESTRICTED_NAMES.includes(t)?console.warn(`'${t}' is a restricted property name and will be ignored.`):"function"==typeof n?this.exposedMethods[t]=n:this.exposedProps[t]=n}initConnection(e){let t={type:a,exposedMethods:Object.keys(this.exposedMethods)};this._sendMessage(t,e)}getProxy(){return new Promise(((e,t)=>{if(this.proxy)return e(this.proxy);this.initConnection(e)}))}disconnect(){this.port.disconnect()}receivedBootstrapInfo(e){this.remoteMethods=e,this.initProxy()}handleMessage(e){let t=this.handleMessageTypes(e);t&&this.port.postMessage(t)}handleMessageTypes(e){let t;switch(e.type){case a:return this.receivedBootstrapInfo(e.exposedMethods),{type:c,id:e.id,exposedMethods:Object.keys(this.exposedMethods)};case c:return this.receivedBootstrapInfo(e.exposedMethods),t=this.getRequestCallback(e.id),t(this.proxy),null;case d:return{type:h,id:e.id,result:this.port.sender?.tab?.id??null};case l:return{type:h,id:e.id,result:this.exposedProps[e.prop]};case u:let n={type:h,id:e.id,result:void 0};return e.prop in this.exposedProps&&(n.result=this.exposedProps[e.prop]=e.value),n;case p:return!e.name in this.exposedMethods?{type:h,id:e.id,result:void 0}:(this._promisify(this.exposedMethods[e.name],e.args).then((t=>this.sendCallResult(e.id,t))).catch((t=>{console.error(t),this.sendCallError(e.id,t)})),null);case h:return t=this.getRequestCallback(e.id),t(e.result),null;case f:throw e.error}}sendCallResult(e,t){let n={type:h,id:e,result:t};return this.port.postMessage(n)}sendCallError(e,t){let n={type:f,id:e,error:t};return this.port.postMessage(n)}initProxy(){return this.proxy=new Proxy({},{get:(e,t)=>this.getTrap(e,t),set:(e,t,n)=>this.setTrap(e,t,n)}),this.proxy}getTrap(e,t){if("then"!==t)return"$getMyTabId"===t?()=>new Promise(((e,t)=>{if(!this.hasTabId)return e(null);let n={type:d};this._sendMessage(n,e)})):this._hasMethod(t)?(...e)=>new Promise(((n,r)=>{let s={type:p,name:t,args:e};this._sendMessage(s,n)})):new Promise(((e,n)=>{let r={type:l,prop:t};this._sendMessage(r,e)}))}setTrap(e,t,n){return new Promise(((e,r)=>{let s={type:u,prop:t,value:n};this._sendMessage(s,e)}))}getNewRequestId(){let e=this.nextRequestId;return this.nextRequestId++,e}getRequestCallback(e){return this.waitingRequests.get(e)}registerCallback(e,t){this.waitingRequests.set(e,t)}_hasMethod(e){return this.remoteMethods.findIndex((t=>t===e))>=0}_sendMessage(e,t){let n=this.getNewRequestId();e.id=n,this.registerCallback(n,t),this.port.postMessage(e)}_promisify(e,t){let n=null;try{n=e(...t)}catch(e){return new Promise(((t,n)=>n(e)))}return"object"==typeof n&&"then"in n?n:new Promise((e=>e(n)))}}})),s.register("3iWja",(function(t,n){e(t.exports,"BgHandlerErrors",(()=>s));class r{constructor(e,t){this.id=e,this.getTextCallback=t}getText(...e){return this.getTextCallback(...e)}}const s={ID_TAKEN:new r("ID_TAKEN",(e=>`The id '${e}' has already been taken. It must be unique.`)),NO_CONNECTION:new r("NO_CONNECTION",((e,t)=>`There is no connection assigned to id '${e}'${t?` connected to the tab ${t}`:""}.`))}})),s.register("5wX0M",(function(t,n){e(t.exports,"default",(()=>a));var r=s("6yLte"),o=s("5I6CI");class i extends r.default{constructor(e,t={},n={context:"content"}){super(),this.scriptId=e??this._uuidv4(),this.connection=null,this.exposedData=t,this.context=n.context??"content",this.connectBackgroundScript()}connectBackgroundScript(){let e="";switch(this.context){case"content":e=o.CONNECTION_PREFIX+this.scriptId;break;case"devtools":if(!chrome.devtools)throw"Cannot set context='devtools' when the script is not in a devtools window.";e=o.CONNECTION_PREFIX_NOTAB+this.scriptId+"-"+chrome.devtools.inspectedWindow.tabId;break;case"tab-agnostic":e=this.scriptId}let t=chrome.runtime.connect({name:e});this.connection=new o.Connection(t,this.exposedData),this.connection.addListener("disconnect",(()=>{this.disconnectBackgroundScript()})),window.addEventListener("beforeunload",(()=>{this.disconnectBackgroundScript()})),this.fireEvent("connected",{})}disconnectBackgroundScript(){this.connection&&this.connection.disconnect(),this.connection=null,this.fireEvent("disconnected",{})}async getConnection(){return this.connection||this.connectBackgroundScript(),await this.connection.getProxy()}_uuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}}var a=i}))}();
//# sourceMappingURL=background.86ced2c0.js.map
